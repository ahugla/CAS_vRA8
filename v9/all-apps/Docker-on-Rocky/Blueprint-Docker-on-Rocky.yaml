formatVersion: 2
outputs:
  __deploymentOverview:
    value: |-

      ## DOCKER ENGINE
      VM based docker engine 
                     

      ### Credits
      - https://www.broadcom.com       
inputs: {}
resources:
  Supervisor_Namespace_1:
    type: CCI.Supervisor.Namespace
    metadata:
      layoutPosition:
        - 0
        - 0
    properties:
      name: demo-namespace-vkrcg
      existing: true
  VM SVC:
    type: CCI.Supervisor.Resource
    metadata:
      layoutPosition:
        - 0
        - 0
    properties:
      context: ${resource.Supervisor_Namespace_1.id}
      manifest:
        apiVersion: vmoperator.vmware.com/v1alpha3
        kind: VirtualMachineService
        metadata:
          name: lb-vm-docker
        spec:
          selector:
            lb-vm-docker: vm-lb-selector
          type: LoadBalancer
          ports:
            - name: ssh
              protocol: TCP
              port: 22
              targetPort: 22
  VM:
    type: CCI.Supervisor.Resource
    dependsOn:
      - VM cloud-init
    metadata:
      layoutPosition:
        - 1
        - 0
    properties:
      wait:
        conditions:
          - type: GuestBootstrap
            status: 'True'
          - type: GuestBootstrap
            status: 'False'
            reason: Failure
            indicatesFailure: true
      context: ${resource.Supervisor_Namespace_1.id}
      manifest:
        apiVersion: vmoperator.vmware.com/v1alpha3
        kind: VirtualMachine
        metadata:
          name: vm-docker
          labels:
            vm-selector: vm-docker
            lb-vm-docker: vm-lb-selector
        spec:
          className: best-effort-small
          imageName: vmi-2e854e3077ea65a5b
          storageClass: cluster-wld01-01a-vsan-storage-policy
          powerState: PoweredOn
          network:
            domainName: mydomain.fr
            nameservers:
              - 8.8.8.8
          bootstrap:
            cloudInit:
              rawCloudConfig:
                name: vm-docker-bootstrap-secret
                key: user-data
  VM cloud-init:
    type: CCI.Supervisor.Resource
    metadata:
      layoutPosition:
        - 2
        - 0
    properties:
      context: ${resource.Supervisor_Namespace_1.id}
      manifest:
        apiVersion: v1
        kind: Secret
        metadata:
          name: vm-docker-bootstrap-secret
          labels:
            vm-selector: vm-docker
        stringData:
          user-data: |
            #cloud-config
            packages:
              - wget
            runcmd:
              - touch /etc/cloud/cloud-init.disabled
              - cd /tmp
              - wget https://raw.githubusercontent.com/ahugla/CAS_vRA8/refs/heads/master/v9/all-apps/Docker-on-Rocky/install-docker.sh
              - chmod 755 install-docker.sh
              - ./install-docker.sh
              - /usr/bin/vmtoolsd --cmd "info-set guestinfo.vmservice.bootstrap.condition True"
